<?php
/**
 * @file
 * Code for the Stanford Related Events feature.
 */

include_once 'stanford_related_events.features.inc';


/*
 * Implements hook_views_default_views_alter().
 *
 * @param array $views
 *   Array of views for the site
 */
function stanford_related_events_views_default_views_alter(&$views) {

  if (array_key_exists('stanford_events_views', $views)) {
   stanford_related_events_stanford_events_views_override($views['stanford_events_views']);
  }
}
/*
 * In case the view is overridden, make a copy of the existing view and alter it
*/
function stanford_related_events_stanford_events_views_override($orig_view){
  $export = array();
  $name = $orig_view->name . '_override';
  $new_view = $orig_view->clone_view();
  $new_view->name = $name;
  $new_view->human_name = $orig_view->human_name . ' Override';
  stanford_related_events_alter_upcoming_block($new_view);
  stanford_related_events_alter_upcoming_page($new_view);

  $new_view->save();
}
/*
 * Add contextual filter for related content to the page display
 *
 * @param object $view
 *   View to be altered
 */
function stanford_related_events_alter_upcoming_page(&$view){

  $handler = $view->display['page']->handler;

  /* Filter criterion: Content: Has taxonomy terms (with depth) */

  $handler->display->display_options['filters']['term_node_tid_depth']['id'] = 'term_node_tid_depth';
  $handler->display->display_options['filters']['term_node_tid_depth']['table'] = 'node';
  $handler->display->display_options['filters']['term_node_tid_depth']['field'] = 'term_node_tid_depth';
  $handler->display->display_options['filters']['term_node_tid_depth']['exposed'] = TRUE;
  $handler->display->display_options['filters']['term_node_tid_depth']['expose']['operator_id'] = 'term_node_tid_depth_op';
  $handler->display->display_options['filters']['term_node_tid_depth']['expose']['label'] = 'Filter by related content';
  $handler->display->display_options['filters']['term_node_tid_depth']['expose']['operator'] = 'term_node_tid_depth_op';
  $handler->display->display_options['filters']['term_node_tid_depth']['expose']['identifier'] = 'term_node_tid_depth';
  $handler->display->display_options['filters']['term_node_tid_depth']['expose']['multiple'] = TRUE;
  $handler->display->display_options['filters']['term_node_tid_depth']['expose']['remember_roles'] = array(
    2 => '2',
    1 => 0,
    6 => 0,
    5 => 0,
    4 => 0,
    3 => 0,
    9 => 0,
    7 => 0,
    8 => 0,
  );
  $handler->display->display_options['filters']['term_node_tid_depth']['type'] = 'select';
  $handler->display->display_options['filters']['term_node_tid_depth']['vocabulary'] = 'stanford_related_content';
  $handler->display->display_options['filters']['term_node_tid_depth']['hierarchy'] = 1;
  $handler->display->display_options['filters']['term_node_tid_depth']['depth'] = '0';

}

/*
 * Copy the block display in the stanford_events_view and add contextual filter for related content
 *
 * @param object $view
 *   View to be altered
 */
function stanford_related_events_alter_upcoming_block(&$view){

  // Copy the block display
  $display_orig = $view->display['block'];
  $handler = $view->new_display('block', 'Filtered Upcoming Block', 'filtered_upcoming_block');

  foreach($display_orig->handler->display->display_options as $key => $value) {
    $handler->set_option($key, $value);
  }

  // Add the contextual filter
  $handler->display->display_options['defaults']['arguments'] = FALSE;
  /* Contextual filter: Content: Has taxonomy term ID (with depth) */
  $handler->display->display_options['arguments']['term_node_tid_depth']['id'] = 'term_node_tid_depth';
  $handler->display->display_options['arguments']['term_node_tid_depth']['table'] = 'node';
  $handler->display->display_options['arguments']['term_node_tid_depth']['field'] = 'term_node_tid_depth';
  $handler->display->display_options['arguments']['term_node_tid_depth']['default_action'] = 'default';
  $handler->display->display_options['arguments']['term_node_tid_depth']['title_enable'] = TRUE;
  $handler->display->display_options['arguments']['term_node_tid_depth']['title'] = 'Related Upcoming Events ';
  $handler->display->display_options['arguments']['term_node_tid_depth']['default_argument_type'] = 'taxonomy_tid';
  $handler->display->display_options['arguments']['term_node_tid_depth']['default_argument_options']['node'] = TRUE;
  $handler->display->display_options['arguments']['term_node_tid_depth']['default_argument_options']['anyall'] = '+';
  $handler->display->display_options['arguments']['term_node_tid_depth']['default_argument_options']['vocabularies'] = array(
    'stanford_related_content' => 'stanford_related_content',
  );
  $handler->display->display_options['arguments']['term_node_tid_depth']['summary']['number_of_records'] = '0';
  $handler->display->display_options['arguments']['term_node_tid_depth']['summary']['format'] = 'default_summary';
  $handler->display->display_options['arguments']['term_node_tid_depth']['summary_options']['items_per_page'] = '25';
  $handler->display->display_options['arguments']['term_node_tid_depth']['specify_validation'] = TRUE;
  $handler->display->display_options['arguments']['term_node_tid_depth']['depth'] = '0';
  $handler->display->display_options['arguments']['term_node_tid_depth']['break_phrase'] = TRUE;

  $handler->display->display_options['use_more_always'] = TRUE;
  $handler->display->display_options['defaults']['link_display'] = FALSE;
  $handler->display->display_options['defaults']['footer'] = FALSE;

  // Footer: Global: See more link
  $handler->display->display_options['footer']['area']['id'] = 'area';
  $handler->display->display_options['footer']['area']['table'] = 'views';
  $handler->display->display_options['footer']['area']['field'] = 'area';
  $handler->display->display_options['footer']['area']['ui_name'] = 'Global: See more link';
  $handler->display->display_options['footer']['area']['content'] = '[hook_views_pre_build:events/upcoming-events]';
  $handler->display->display_options['footer']['area']['format'] = 'content_editor_text_format';
  $handler->display->display_options['footer']['area']['tokenize'] = TRUE;
  $handler->display->display_options['defaults']['arguments'] = FALSE;

}

/*
 * Implements hook_views_pre_build().
 *
 */
function stanford_related_events_views_pre_build(&$view){
  if ($view->name == "stanford_events_views"){
    if (($view->current_display == "filtered_upcoming_block") ||
      ($view->current_display == "block_5")){
      $pattern = "/\[hook_views_pre_build:.*\]/";
      $subject = $view->footer["area"]->options["content"];
      $matches = array();
      preg_match($pattern, $subject, $matches);
      if (!empty($matches)){

        // Build the URL.
        $parts = explode(":", $matches[0]);
        $url = str_replace("]", "", $parts[1]);
        $options = array( 'attributes' => array( 'class' => array('more-link')),
          'query' => array( stanford_related_events_build_tax_args())
        );
        $a = l("See more related events", $url, $options);

        // Replace text with the URL.
        $subject = preg_replace($pattern, $a, $subject);
        $view->footer["area"]->options["content"] = $subject;
      }
    }
  }
}
/*
 * Takes the related_content terms from the current node and builds them into arguments for link options.
 *
 * @returns array of arguments
 */
function stanford_related_events_build_tax_args(){
  $result = array();
  if (arg(0) == 'node') {
    $nid = arg(1);
    if (is_numeric($nid)){
      $node = node_load($nid);
      if ((!is_null($node)) && (isset($node->field_s_related_content['und']))) {
        foreach($node->field_s_related_content['und'] as $key => $value){
          $result['term_node_tid_depth[' . $key . ']'] = $value['tid'];
        }
      }
    }
  }
  return $result;
}

/**
 * Implements hook_views_default_view_override_views_to_override().
 */
function stanford_related_events_views_default_view_override_views_to_override() {
  return array(
    // Override the default view with the one provided by my_module.
    'stanford_events_views' => 'stanford_events_views_override',
  );
}

